---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# queryparser <img src="man/figures/logo.png" align="right" width="120" />

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/queryparser)](https://cran.r-project.org/package=queryparser)
[![Travis build status](https://travis-ci.org/ianmcook/queryparser.svg?branch=master)](https://travis-ci.org/ianmcook/queryparser)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/ianmcook/queryparser?branch=master&svg=true)](https://ci.appveyor.com/project/ianmcook/queryparser)
[![Codecov test coverage](https://codecov.io/gh/ianmcook/queryparser/branch/master/graph/badge.svg)](https://codecov.io/gh/ianmcook/queryparser?branch=master)
<!-- badges: end -->

**queryparser** translates SQL queries into lists of unevaluated R expressions.

| ⚠️ Most R users should not directly use queryparser. Instead, use it through [tidyquery](https://github.com/ianmcook/tidyquery).
| --- |

## Installation

Install the released version of **queryparser** from [CRAN](https://CRAN.R-project.org/package=queryparser) with:

``` r
install.packages("queryparser")
```

Or install the development version from [GitHub](https://github.com/ianmcook/queryparser) with:

``` r
# install.packages("devtools")
devtools::install_github("ianmcook/queryparser")
```

## Usage

Call the function `parse_query()`, passing a `SELECT` statement enclosed in quotes as the first argument:

```{r}
library(queryparser)

parse_query("SELECT DISTINCT carrier FROM flights WHERE dest = 'HNL'")
```

Queries can include the clauses `SELECT`, `FROM`, `WHERE`, `GROUP BY`, `HAVING`, `ORDER BY`, and `LIMIT`:

```{r}
parse_query(
" SELECT origin, dest,
    COUNT(flight) AS num_flts,
    round(AVG(distance)) AS dist,
    round(AVG(arr_delay)) AS avg_delay
  FROM flights
  WHERE distance BETWEEN 200 AND 300
    AND air_time IS NOT NULL
  GROUP BY origin, dest
  HAVING num_flts > 5000
  ORDER BY num_flts DESC, avg_delay DESC
  LIMIT 100;"
)
```

Set the argument `tidyverse` to `TRUE` to use functions from [tidyverse](https://www.tidyverse.org) packages including [dplyr](https://dplyr.tidyverse.org), [stringr](https://stringr.tidyverse.org), and [lubridate](https://lubridate.tidyverse.org) in the R expressions:

```{r}
parse_query("SELECT COUNT(*) AS n FROM t WHERE x BETWEEN y AND z ORDER BY n DESC", tidyverse = TRUE)
```

**queryparser** will translate only explicitly allowed functions and operators, preventing injection of malicious code:

```{r error=TRUE}
parse_query("SELECT x FROM y WHERE system('rm -rf /')")
```

## Current Limitations

**queryparser** does not currently support:

- Subqueries
- Unions
- SQL-89-style (implicit) join notation
- The `WITH` clause (common table expressions)
- `OVER` expressions (window or analytic functions)
- Some SQL functions and operators

**queryparser** currently has the following known limitations:

- Some SQL expressions will translate only when `tidyverse` is set to `TRUE`. An example of this is `COUNT(DISTINCT )` expressions with multiple arguments.
- When logical operators (such as `IS NULL`) have unparenthesized expressions as their operands, R will interpret the resulting code using a different order of operations than a SQL engine would. When using an expression as the operand to a logical operator, always enclose the expression in parentheses.
- When `tidyverse` is set to `TRUE`, SQL expressions that use `CASE` or `coalesce()` with `NULL`s in the arguments can return expressions that throw data type errors when evaluated. This is because `NULL` translates to `NA`, which is by default a logical constant (not a numeric, integer, or character constant). To work around this, cast `NULL` to the expected data type in the SQL expression.
- The error messages that occur when attempting to parse invalid or unrecognized SQL are often non-informative.
- When one or more individual expressions within a `SELECT` statement are longer than 500 characters, errors or unexpected results can occur.

## Non-Goals

**queryparser** is not intended to:

- Translate other types of SQL statements (such as `INSERT` or `UPDATE`)
- Customize translations for specific SQL dialects
- Fully validate the syntax of the `SELECT` statements passed to it
